<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <div id="uinfo">
      <div id="uinfo-name"></div>
      <div id="uinfo-gender"></div>

      <button type="button" id="ulogout">退出登陆</button>
    </div>

    <form id="uform">
      <input type="text" name="uname" value="" placeholder="用户名" />
      <input type="text" name="upwd" value="" placeholder="密码" />
      <button type="button" id="usubmit">登陆</button>
    </form>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
        $('#uinfo').hide()
        $('#uform').hide()
        // 页面一进来就验证是否已经登陆
        $.ajax({
          type: 'GET',
          url: 'https://dawn.sso-client-1.cn/api/check/login',
          data: {},
          dataType: 'json',
          success: function (data) {
            if (data.success === false) {
              $('#uform').show()
            } else {
              $('#uinfo-name').html(data.data.uname)
              $('#uinfo-gender').html(data.data.ugender)
              $('#uinfo').show()
            }
          }
        })

        $('#usubmit').on('click', function () {
          let vals = $('#uform').serialize()
          $.ajax({
            type: 'POST',
            url: 'https://dawn.sso-client-1.cn/api/login',
            data: vals,
            dataType: 'json',
            success: function (data) {
              if (data.success === true) {
                $.each(data.data.domainList, function (index, url) {
                  console.log(url)
                  $.ajax({
                    url: url + '/api/add/cookie?token=' + data.data.token,
                    type: 'get',
                    dataType: 'jsonp' //指定服务器返回的数据类型
                  })
                })

                setTimeout(() => {
                  window.location.reload()
                }, 1000)
              }
            }
          })
        })

        $('#ulogout').click(function (event) {
          $.ajax({
            url: 'https://dawn.sso-api.cn/logout',
            type: 'get',
            jsonp: 'callback', //传递给请求处理程序或页面的，用以获得jsonp回调函数名的参数名(默认为:callback)
            jsonpCallback: 'success_jsonpCallback', //自定义的jsonp回调函数名称，默认为jQuery自动生成的随机函数名
            dataType: 'jsonp', //指定服务器返回的数据类型
            success: function (data) {
              console.log(data)
              $.each(data, function (index, url) {
                $.ajax({
                  url: url + '/api/logout',
                  type: 'get',
                  dataType: 'jsonp' //指定服务器返回的数据类型
                })
              })

              setTimeout(() => {
                window.location.reload()
              }, 1000)
            },
            error: function (data) {
              console.log(data)
              // console.log(data.jqXHR + ' ' + data.status + ' ' + data.error)
            }
          })
        })
      })
    </script>
  </body>
</html>
